<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Forecasting Customer Lifetime Value Using RFM-Analysis and Markov Chain</title>
    <meta name="viewport" content="width=device-width">
    <meta name="description" content="">
    <link rel="canonical" href="/ml/2022/03/01/Customer-Lifetime-Value-Prediction/">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon-96x96.png">

    <!--flattr.com -->
    <meta name="flattr:id" content="nlxxeo">

    <!-- Stuff added for BibTex dropdown menu -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.0/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/assets/css/style.css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css">

        <!--KaTeX-->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
        <script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"></script>
        <script>
         document.addEventListener("DOMContentLoaded", function() {
             renderMathInElement(document.body, {
                 // ...options...
             });
         });
        </script>
        
</head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-MJT6KHN3F1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-MJT6KHN3F1');
</script>
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans&display=swap" rel="stylesheet">

    <body>
    <a name="top"></a>
    <header class="site-header">
  <div class="wrap">

    <div style="float:left; margin-top:10px; margin-right:10px;">
      <a href="/about/">
    <img src="/sk.png" width="45">
  </a>
  </div>

    <a class="site-title site-link" href="/about/">Skander Kacem</a> <br>
    <p class="site-subtitle" style="font-style: italic; text-align: center;">Thinking out loud</p>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
           viewBox="0 0 18 15" enable-background="new 0 0 18 15" xml:space="preserve">
          <path fill="#505050" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0
            h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#505050" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484
            h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#505050" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0
            c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>
      <div class="trigger">
        <a class="site-link" href="/thoughts/">Thoughts</a>
        <a class="site-link" href="/readings/">Readings</a>
        <a class="site-link" href="/notes/">Notes</a>
      </div>
    </nav>
  </div>
</header>

    <div class="page-content">
      <div class="wrap">
      <div class="post">

  <header class="post-header">
    <h1>Forecasting Customer Lifetime Value Using RFM-Analysis and Markov Chain</h1>
    <div class="post-meta">
      <div class="post-date">
        <i class="fa fa-calendar-o"></i>
        2022-03-01
      </div>
      <div class="post-tags">
        <i class="fa fa-tags"></i>
        
          <span><a href="/tag/Business Analytics"><code class="highligher"><nobr>Business Analytics</nobr></code></a></span>
        
          <span><a href="/tag/Tutorial"><code class="highligher"><nobr>Tutorial</nobr></code></a></span>
        
          <span><a href="/tag/RFM Analysis"><code class="highligher"><nobr>RFM Analysis</nobr></code></a></span>
        
          <span><a href="/tag/CLV"><code class="highligher"><nobr>CLV</nobr></code></a></span>
        
      </div>
    </div>
  </header>

  <article class="post-content">
  <h2 id="introduction">Introduction</h2>

<p>If there’s one thing you should be doing in your business right now, and I’m willing to bet you’re not, it’s Customer lifetime value (CLV) analysis.</p>

<p>CLV is the present value of the future cash flows or payments a company will realize from a customer over the entire relationship. It helps businesses understand how to best use their marketing budget and strategies to grow their customer base. For instance, by understanding CLV, a business can determine how much it can afford to spend to acquire a new customer, identify and target future top customers or minimize spending for unprofitable customers.
In fact, whenever a business makes a decision about a customer relationship, it wants to make sure that the decision is going to be profitable in the long run.<br />
In this article, we will demonstrate how to use Python to implement a CLV forecasting model. It’s important to note that we assume a non-contractual business setting. In a contract-based business, customers are typically locked into long-term agreements, where they pay the same fee on a recurring basis,making it relatively easy to estimate CLV based on retention rate.<br />
However, in a non-contractual environment, where customers can come and go as they please, estimating variable future revenue streams in terms of time and amount can be more challenging.
Fortunately, we’ve already addressed similar issues in previous articles and know that nothing beats the RFM trinity when it comes to predicting customer behavior. So, if you are unfamiliar with RFM-analysis (recency, frequency, monetary value), take a moment to read my previous article.</p>

<p>Now, before I get into the code, I’d like to briefly discuss some of the theory. Those who are simply interested in programming can skip the next three sections and go straight to CLV in Python.</p>

<h2 id="from-product-centric-to-customer-centric-marketing">From Product-Centric to Customer-Centric Marketing</h2>

<p>Until recently, retailers have approached marketing from a product-oriented perspective, focusing mainly on the features, benefits, and prices of their products and services while ignoring the needs and wants of their customer base. The focus of this approach is on quick transactions, using  marketing mix and advertising campaigns to grab new consumers’ attention and persuade them to make an impulse purchase. Sales are then treated as faceless transactions with the ultimate goal to increase conversion and short-term profits.</p>

<p>However, in today’s competitive business landscape, retailers are looking for new ways to differentiate themselves from their competitors. Those that adopt customer-centric marketing can provide tailored experiences that are engaging for their customer base. This requires understanding customers on an individual level and forecasting their CLV to determine how profitable they will be in a long-term relationship. After all, you don’t want to waste your time and marketing budget on unprofitable customers.</p>

<p>Indeed, the transition to a more customer-centric marketing strategy among retailers comes from a combination of factors such as competitive pressures, changing consumer behavior, digital transformation and data availability.
With the advent of social media and e-commerce, customers have gained greater access to a variety of retailers offering the same or similar products and have become more knowledgeable in their purchasing decisions. They now expect organizations to understand and cater to their individual needs and wants, and have higher expectations for personalized and tailored value-added services and buying experiences.<br />
In addition, digital transformation and the availability of data have made it easier for retailers to gain insights into customers’ behavior, preferences and concerns. This data can be used to create more targeted and personalized marketing campaigns and improve products and services. Customer relationship management (CRM) tools also enabled retailers to manage customer interactions more efficiently and effectively while improving overall customer satisfaction and retention.</p>

<p>In summary, it is essential for organizations to adopt both product and customer-centric marketing strategies to remain competitive in saturated marketplaces.<br />
A customer-centric approach is important for building strong relationships with the customer base and fostering trust and loyalty, which can attract repeat purchases, increase word of mouth and prevent customers from turning to competitors. On the other hand, a product-centric approach is also important when it comes to attracting new customers and generating initial interest in a product or service.<br />
By using both strategies, retailers can effectively balance the needs of new customer acquisition and customer retention, ultimately leading to long-term success in the marketplace.</p>

<h2 id="motivation-and-use-cases">Motivation and Use Cases</h2>

<p>Imagine your company launches a big campaign to attract new customers. You invest in PR, advertising and email campaigns, buy a lot of online ads, create a special promotion and offer a big discount to first-time buyers. However, after all these efforts, the campaign results in only a small number of new customers and sales that don’t even cover the cost of the campaign. Well, you could argue that these new customers will stay with you and continue to buy, making the campaign worthwhile in the long run. But wouldn’t it be nice to have a way to measure whether or not that’s true? That’s where customer lifetime value (CLV) models come in. These models look at past and current customer behavior to predict how much revenue a customer will bring in over time. Only then can you determine if the cost of customer acquisition was worth it.</p>

<p>CLV models offer a wide range of practical applications. For example, you might compare one acquisition campaign to another. Suppose you are comparing two campaigns, one with a substantial discount and one with a modest discount. The advertising campaign with the greater discount will likely attract more customers, but those customers will be less profitable in the short term and much less loyal in the long term once the discount is removed. After all, the only reason they came in the first place was to take advantage of the discount. Offering a small discount and bringing in fewer customers might be a better strategy, assuming of course, they are more loyal and bring in more money in the long run. But how can you be sure about that, if you can’t quantify the long-term value of your customers.<br />
CLV is also very useful for existing customers. In fact, one of the best uses of Customer Lifetime Value is to determine which customers or customer segments are more valuable to the future growth of your business. Let’s say you have two segments, with customers in segment one contributing an average of $100 per quarter to revenue. Customers in segment two generate an average of $150. At first glance, you might want to put a little more effort into satisfying and retaining the customers in segment two. Perhaps additional resources should be allocated. Make sure they have access to the best customer service possible. Keep an eye on loyalty, and so on. However, an analysis of their lifetime value shows that customers in the first segment are more loyal, stay longer, and regularly spend more money with the company. Customers in the second segment are simply seasonal and not loyal at all. They switch to the competition as soon as they discover a better offer or special promotion, and may only be one-time customers. Comparing lifetime values, customers in the first segment spend an average $5,000 during all they relationship with your company, while customers in segment two spend an average of only $600. Wouldn’t it be wonderful if you knew how to calculate these numbers in the first place so you could focus your marketing resources on the most valuable customers over time? What do you think would happen if you didn’t?</p>

<h2 id="the-migration-model">The Migration Model</h2>

<p>CLV can be tricky to compute. Some methods are too simplistic to be useful, while others are too complex. In this tutorial, we’ll take a middle-of-the-road approach and use segmentation - a concept we’ve already covered in previous articles - to compute CLV.</p>

<p>You may recall that we talked about managerial segmentation, where you can assign customers to different segments based on their behaviors like recency, frequency, monetary value (RFM). We also discussed how you can use this segmentation not just on current data, but also retrospectively on past data. This provides  significant information into how your business is performing, which segments are increasing and on the account of what other segments, and whether you’re attracting more new consumers than before.</p>

<p>Each segmentation is like a snapshot of your customer database. By taking multiple snapshots over time, you can see how customers move from one segment to another. For example, some high-value customers may stay in the same segment while others move to lower-value segments. By analyzing these transitions, you can predict how your customers will behave in the future.<br />
To make this easier, we will use a tool called a transition matrix, also known as migration model. It is a mathematical representation of the transition probabilities of a Markov chain. It is a square matrix and in this case shows the probability of customers moving from one segment to another. Each row represents the current segment, while each column represents the segment customers were in a year ago.  The sum of each row should equal 1, which means that the probabilities of switching from one state to another are equal to 1. It’s important to note that by definition, some transitions may have zero probability, such as a customer moving from active to inactive in just one period. This is normal and expected.<br />
Based on the analysis of this matrix, you can predict how customers will behave in the future.</p>

<h2 id="forecasting-customer-lifetime-value-in-python">Forecasting Customer Lifetime Value in Python</h2>

<p>Now that we are done with the theory, let’s move on to the implementation. In the following we want to implement a CLV model using RFM and a first-order Markov chain. We will reuse the same data as in the previous blog post, as well as the first part of implementation, which includes RFM analysis and customer segmentation for the year 2014.
The data consists of 51,243 observations across three variables:</p>

<ol>
  <li>Customer ID,</li>
  <li>purchase amount in USD and</li>
  <li>date of purchase</li>
</ol>

<p>It includes all sales from January 2, 2005 through December 31, 2015. There are no missing records in the dataset.</p>

<h3 id="rfm-analysis-and-customer-segmentation-for-the-current-year">RFM Analysis and Customer Segmentation for The Current Year</h3>

<p>I assume by now you are familiar with the dataset and customer segmentation techniques, so I won’t go into detail here. I’m going to load the dataset, set it up as we’ve done before, and then I’m going to segment it based on RFM analysis, with the assumption that we’re at the end of 2015.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="c1"># import needed packages
</span><span class="kn">import</span> <span class="n">matplotlib</span> <span class="k">as</span> <span class="n">mpl</span>
<span class="kn">import</span> <span class="n">matplotlib.pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="n">pandas</span> <span class="k">as</span> <span class="n">pd</span>
<span class="kn">import</span> <span class="n">patsy</span>
<span class="kn">import</span> <span class="n">squarify</span>
<span class="kn">import</span> <span class="n">statsmodels.api</span> <span class="k">as</span> <span class="n">sm</span>
<span class="kn">from</span> <span class="n">pandasql</span> <span class="kn">import</span> <span class="n">sqldf</span>
<span class="kn">from</span> <span class="n">tabulate</span> <span class="kn">import</span> <span class="n">tabulate</span>

<span class="c1"># Set up the notebook environment
</span><span class="n">pysqldf</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">q</span><span class="p">:</span> <span class="nf">sqldf</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="nf">globals</span><span class="p">())</span>
<span class="o">%</span><span class="n">precision</span> <span class="o">%</span><span class="p">.</span><span class="mi">2</span><span class="n">f</span>
<span class="n">pd</span><span class="p">.</span><span class="n">options</span><span class="p">.</span><span class="n">display</span><span class="p">.</span><span class="n">float_format</span> <span class="o">=</span> <span class="sh">"</span><span class="s">{:,.2f}</span><span class="sh">"</span><span class="p">.</span><span class="nb">format</span>
<span class="n">plt</span><span class="p">.</span><span class="n">rcParams</span><span class="p">[</span><span class="sh">"</span><span class="s">figure.figsize</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span>

<span class="c1"># Load text file into a local variable
</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sh">"</span><span class="s">customer_id</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">purchase_amount</span><span class="sh">"</span><span class="p">,</span> <span class="sh">"</span><span class="s">date_of_purchase</span><span class="sh">"</span><span class="p">]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">read_csv</span><span class="p">(</span><span class="sh">"</span><span class="s">purchases.txt</span><span class="sh">"</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="sh">"</span><span class="se">\t</span><span class="sh">"</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">columns</span><span class="p">)</span>

<span class="c1"># interpret the last column as datetime
</span><span class="n">df</span><span class="p">[</span><span class="sh">"</span><span class="s">date_of_purchase</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="sh">"</span><span class="s">date_of_purchase</span><span class="sh">"</span><span class="p">],</span> <span class="nb">format</span><span class="o">=</span><span class="sh">"</span><span class="s">%Y-%m-%d</span><span class="sh">"</span><span class="p">)</span>

<span class="c1"># Extract year of purchase and save it as a column
</span><span class="n">df</span><span class="p">[</span><span class="sh">"</span><span class="s">year_of_purchase</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="sh">"</span><span class="s">date_of_purchase</span><span class="sh">"</span><span class="p">].</span><span class="n">dt</span><span class="p">.</span><span class="n">year</span>

<span class="c1"># Add a day_since column showing the difference between last purchase and a basedate
</span><span class="n">basedate</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">Timestamp</span><span class="p">(</span><span class="sh">"</span><span class="s">2016-01-01</span><span class="sh">"</span><span class="p">)</span>
<span class="n">df</span><span class="p">[</span><span class="sh">"</span><span class="s">days_since</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">basedate</span> <span class="o">-</span> <span class="n">df</span><span class="p">[</span><span class="sh">"</span><span class="s">date_of_purchase</span><span class="sh">"</span><span class="p">]).</span><span class="n">dt</span><span class="p">.</span><span class="n">days</span>

<span class="c1"># SQL for the RFM analysis 
</span><span class="n">q</span> <span class="o">=</span> <span class="sh">"""</span><span class="s">
        SELECT customer_id,
        MIN(days_since) AS </span><span class="sh">'</span><span class="s">recency</span><span class="sh">'</span><span class="s">,
        MAX(days_since) AS </span><span class="sh">'</span><span class="s">first_purchase</span><span class="sh">'</span><span class="s">,
        COUNT(*) AS </span><span class="sh">'</span><span class="s">frequency</span><span class="sh">'</span><span class="s">,
        AVG(purchase_amount) AS </span><span class="sh">'</span><span class="s">amount</span><span class="sh">'</span><span class="s">
        FROM df GROUP BY 1</span><span class="sh">"""</span>
<span class="n">customers_2015</span> <span class="o">=</span> <span class="nf">sqldf</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>

<span class="c1"># Customer segmentation in 2015
</span><span class="n">customers_2015</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">recency</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">365</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">'</span><span class="s">inactive</span><span class="sh">'</span>
<span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span>  <span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">].</span><span class="nf">fillna</span><span class="p">(</span><span class="sh">'</span><span class="s">NA</span><span class="sh">'</span><span class="p">)</span>
<span class="n">customers_2015</span><span class="p">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">recency</span><span class="sh">'</span><span class="p">]</span><span class="o">&lt;=</span> <span class="mi">365</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> 
                   <span class="p">(</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">recency</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">356</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span> <span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">cold</span><span class="sh">"</span>
<span class="n">customers_2015</span><span class="p">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">recency</span><span class="sh">'</span><span class="p">]</span><span class="o">&lt;=</span> <span class="mi">365</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> 
                   <span class="p">(</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">recency</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">365</span><span class="o">*</span><span class="mi">1</span><span class="p">),</span> <span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">warm</span><span class="sh">"</span>
<span class="n">customers_2015</span><span class="p">.</span><span class="n">loc</span><span class="p">[</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">recency</span><span class="sh">'</span><span class="p">]</span><span class="o">&lt;=</span> <span class="mi">365</span><span class="p">,</span> <span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">active</span><span class="sh">"</span>
<span class="n">customers_2015</span><span class="p">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">warm</span><span class="sh">"</span><span class="p">)</span> <span class="o">&amp;</span>
                  <span class="p">(</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">first_purchase</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">365</span><span class="o">*</span><span class="mi">2</span><span class="p">),</span> <span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">new warm</span><span class="sh">"</span>
<span class="n">customers_2015</span><span class="p">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">warm</span><span class="sh">"</span><span class="p">)</span> <span class="o">&amp;</span>
                  <span class="p">(</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">amount</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">),</span> <span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">warm low value</span><span class="sh">"</span>
<span class="n">customers_2015</span><span class="p">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">warm</span><span class="sh">"</span><span class="p">)</span> <span class="o">&amp;</span>
                  <span class="p">(</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">amount</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">),</span> <span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">warm high value</span><span class="sh">"</span>
<span class="n">customers_2015</span><span class="p">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">active</span><span class="sh">"</span><span class="p">)</span> <span class="o">&amp;</span>
                  <span class="p">(</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">first_purchase</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">365</span><span class="p">),</span> <span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">new active</span><span class="sh">"</span>
<span class="n">customers_2015</span><span class="p">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">active</span><span class="sh">"</span><span class="p">)</span> <span class="o">&amp;</span>
                  <span class="p">(</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">amount</span><span class="sh">'</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">),</span> <span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">active low value</span><span class="sh">"</span>
<span class="n">customers_2015</span><span class="p">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">]</span> <span class="o">==</span> <span class="sh">"</span><span class="s">active</span><span class="sh">"</span><span class="p">)</span> <span class="o">&amp;</span>
                  <span class="p">(</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">amount</span><span class="sh">'</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">),</span> <span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">]</span> <span class="o">=</span> <span class="sh">"</span><span class="s">active high value</span><span class="sh">"</span>

<span class="c1"># Transform segment column datatype from object to category
</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">"</span><span class="s">segment</span><span class="sh">"</span><span class="p">]</span> <span class="o">=</span> <span class="n">customers_2015</span><span class="p">[</span><span class="sh">"</span><span class="s">segment</span><span class="sh">"</span><span class="p">].</span><span class="nf">astype</span><span class="p">(</span><span class="sh">"</span><span class="s">category</span><span class="sh">"</span><span class="p">)</span>
<span class="c1"># Re-order segments in a better readable way
</span><span class="n">sorter</span> <span class="o">=</span> <span class="p">[</span>
    <span class="sh">"</span><span class="s">inactive</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">cold</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">warm high value</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">warm low value</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">new warm</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">active high value</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">active low value</span><span class="sh">"</span><span class="p">,</span>
    <span class="sh">"</span><span class="s">new active</span><span class="sh">"</span><span class="p">,</span>
<span class="p">]</span>
<span class="n">customers_2015</span><span class="p">.</span><span class="n">segment</span><span class="p">.</span><span class="n">cat</span><span class="p">.</span><span class="nf">set_categories</span><span class="p">(</span><span class="n">sorter</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="n">customers_2015</span><span class="p">.</span><span class="nf">sort_values</span><span class="p">([</span><span class="sh">"</span><span class="s">segment</span><span class="sh">"</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<p>You can do 2014 by yourself. It is almost the same as with 2015. The only minor difference resides in the SQL query. Hint: Remember we are in 2014, so we want to filter out everything after 2014 and don’t forget to order the segments exactly as for 2015.</p>

<h3 id="transition-matrix">Transition Matrix</h3>

<p>Well, now we have all the information we need. We have the customers and their segments for both 2014 and 2015. Next, we need to merge these two datasets into one new variable. However, there is a trick to this. The columns in each dataset have the same names, so if we merge them simply, they will overwrite each other. To avoid this, we will specify that we want to merge them by customer ID and keep all the customers from the left dataset as we’ve done before.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># merge both customer segmentation years 
</span><span class="n">new_data</span> <span class="o">=</span> <span class="n">customers_2014</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="n">customers_2015</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="sh">'</span><span class="s">left</span><span class="sh">'</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="sh">'</span><span class="s">customer_id</span><span class="sh">'</span><span class="p">)</span>

<span class="n">new_data</span><span class="p">.</span><span class="nf">info</span><span class="p">()</span>
</code></pre></div></div>

<div class="language-tex highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
Int64Index: 16905 entries, 0 to 16904
Data columns (total 11 columns):
 #   Column            Non-Null Count  Dtype   
---  ------            --------------  -----   
 0   customer<span class="p">_</span>id       16905 non-null  int64   
 1   recency<span class="p">_</span>x         16905 non-null  int64   
 2   first<span class="p">_</span>purchase<span class="p">_</span>x  16905 non-null  int64   
 3   frequency<span class="p">_</span>x       16905 non-null  int64   
 4   amount<span class="p">_</span>x          16905 non-null  float64 
 5   segment<span class="p">_</span>x         16905 non-null  category
 6   recency<span class="p">_</span>y         16905 non-null  int64   
 7   first<span class="p">_</span>purchase<span class="p">_</span>y  16905 non-null  int64   
 8   frequency<span class="p">_</span>y       16905 non-null  int64   
 9   amount<span class="p">_</span>y          16905 non-null  float64 
 10  segment<span class="p">_</span>y         16905 non-null  category
dtypes: category(2), float64(2), int64(7)
memory usage: 1.3 MB
</code></pre></div></div>
<p>Now, we have a large dataset with columns for recency, first purchase, frequency, amount, and segments with an <code class="language-plaintext highlighter-rouge">_x</code> or <code class="language-plaintext highlighter-rouge">_y</code> appended to the column name. The <code class="language-plaintext highlighter-rouge">_x</code> columns represent the data from the 2014 customers and the <code class="language-plaintext highlighter-rouge">_y</code> columns represent the data from the 2015 customers.</p>

<p>The two columns that we’re  interested in are <code class="language-plaintext highlighter-rouge">segment_x</code> and <code class="language-plaintext highlighter-rouge">segment_y</code>, which represent the segments for the customers in 2014 and 2015, respectively.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Let's print the obtained segment_x and segment_y columns
</span><span class="nf">print</span><span class="p">(</span><span class="nf">tabulate</span><span class="p">(</span><span class="n">new_data</span><span class="p">[[</span><span class="sh">'</span><span class="s">customer_id</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">segment_x</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">segment_y</span><span class="sh">'</span>
                         <span class="p">]].</span><span class="nf">tail</span><span class="p">(),</span> <span class="n">headers</span><span class="o">=</span><span class="sh">'</span><span class="s">keys</span><span class="sh">'</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="sh">'</span><span class="s">psql</span><span class="sh">'</span><span class="p">)</span>
      <span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">+-------+---------------+-------------+------------------+</span>
<span class="o">|</span>       <span class="o">|</span>   <span class="n">customer_id</span> <span class="o">|</span> <span class="n">segment_x</span>   <span class="o">|</span> <span class="n">segment_y</span>        <span class="o">|</span>
<span class="o">|-------+---------------+-------------+------------------|</span>
<span class="o">|</span> <span class="mi">16900</span> <span class="o">|</span>        <span class="mi">221470</span> <span class="o">|</span> <span class="n">new</span> <span class="n">active</span>  <span class="o">|</span> <span class="n">new</span> <span class="n">warm</span>         <span class="o">|</span>
<span class="o">|</span> <span class="mi">16901</span> <span class="o">|</span>        <span class="mi">221460</span> <span class="o">|</span> <span class="n">new</span> <span class="n">active</span>  <span class="o">|</span> <span class="n">active</span> <span class="n">low</span> <span class="n">value</span> <span class="o">|</span>
<span class="o">|</span> <span class="mi">16902</span> <span class="o">|</span>        <span class="mi">221450</span> <span class="o">|</span> <span class="n">new</span> <span class="n">active</span>  <span class="o">|</span> <span class="n">new</span> <span class="n">warm</span>         <span class="o">|</span>
<span class="o">|</span> <span class="mi">16903</span> <span class="o">|</span>        <span class="mi">221430</span> <span class="o">|</span> <span class="n">new</span> <span class="n">active</span>  <span class="o">|</span> <span class="n">new</span> <span class="n">warm</span>         <span class="o">|</span>
<span class="o">|</span> <span class="mi">16904</span> <span class="o">|</span>        <span class="mi">245840</span> <span class="o">|</span> <span class="n">new</span> <span class="n">active</span>  <span class="o">|</span> <span class="n">new</span> <span class="n">warm</span>         <span class="o">|</span>
<span class="o">+-------+---------------+-------------+------------------+</span>
</code></pre></div></div>

<p>To further analyze the data, I’m going to create a cross-tabulation (or “occurrence table”) that shows how many customers fit into specific segment combinations for both 2014 and 2015. This will allow us to see how many customers moved between segments or stayed in the same segment between the two years.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># We are going to cross segments 2014 and 2015 and see how many people are
# in both an meet this criterium
</span><span class="n">transition</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nf">crosstab</span><span class="p">(</span><span class="n">new_data</span><span class="p">[</span><span class="sh">'</span><span class="s">segment_x</span><span class="sh">'</span><span class="p">],</span> <span class="n">new_data</span><span class="p">[</span><span class="sh">'</span><span class="s">segment_y</span><span class="sh">'</span><span class="p">])</span>
<span class="nf">print</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-tex highlighter-rouge"><div class="highlight"><pre class="highlight"><code>segment<span class="p">_</span>y          inactive  cold  warm high value  warm low value  new warm  <span class="k">\
</span>segment<span class="p">_</span>x                                                                      
inactive               7227     0                0               0         0   
cold                   1931     0                0               0         0   
warm high value           0    75                0               0         0   
warm low value            0   689                0               0         0   
new warm                  0  1139                0               0         0   
active high value         0     0              119               0         0   
active low value          0     0                0             901         0   
new active                0     0                0               0       938   

segment<span class="p">_</span>y          active high value  active low value  
segment<span class="p">_</span>x                                               
inactive                          35               250  
cold                              22               200  
warm high value                   35                 1  
warm low value                     1               266  
new warm                          15                96  
active high value                354                 2  
active low value                  22              2088  
new active                        89               410  
</code></pre></div></div>

<p>If we examine the results, we can see that we are almost there. The table above closely resembles the transition matrix we discussed earlier. The rows represent the segments that customers belonged to in 2014: <code class="language-plaintext highlighter-rouge">segment_x</code>. The columns show the different segments that customers moved to in 2015 or <code class="language-plaintext highlighter-rouge">segment_y</code>. Each value in the table represents the number of customers who moved from one segment to another between the two years.</p>

<p>For example, among all the inactive customers in 2014, 7,227 remained inactive in 2015, 35 became active high value customers, and 250 became active low value customers. Additionally, among all the new active customers in 2014, 938 didn’t purchase anything the next year and became new warm customers. That’s about two out of three new customers. The others became active high value or active low value customers.</p>

<p>However, we don’t really care about the absolute numbers, what we care about are the proportions, likelihoods, and probabilities of shifting from one segment to the next over time. So instead of working with the absolute numbers as represented in the above table, we will divide each row by the row sum. This will give us a table where the sum of each row is equal to one.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">transition</span> <span class="o">=</span> <span class="n">transition</span><span class="p">.</span><span class="nf">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">/</span><span class="n">x</span><span class="p">.</span><span class="nf">sum</span><span class="p">(),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-tex highlighter-rouge"><div class="highlight"><pre class="highlight"><code>segment<span class="p">_</span>y          inactive  cold  warm high value  warm low value  new warm  <span class="k">\
</span>segment<span class="p">_</span>x                                                                      
inactive               0.96  0.00             0.00            0.00      0.00   
cold                   0.90  0.00             0.00            0.00      0.00   
warm high value        0.00  0.68             0.00            0.00      0.00   
warm low value         0.00  0.72             0.00            0.00      0.00   
new warm               0.00  0.91             0.00            0.00      0.00   
active high value      0.00  0.00             0.25            0.00      0.00   
active low value       0.00  0.00             0.00            0.30      0.00   
new active             0.00  0.00             0.00            0.00      0.65   

segment<span class="p">_</span>y          active high value  active low value  
segment<span class="p">_</span>x                                               
inactive                        0.00              0.03  
cold                            0.01              0.09  
warm high value                 0.32              0.01  
warm low value                  0.00              0.28  
new warm                        0.01              0.08  
active high value               0.75              0.00  
active low value                0.01              0.69  
new active                      0.06              0.29  
</code></pre></div></div>

<p>Well that looks better. So,  if you were an inactive customer in 2014, you had a 96.2% chance of remaining inactive in 2015. And if you were an active high value customer, you had a 74.5% chance of remaining in that segment and a 25% chance of becoming a warm high value customer next year.</p>

<p>That’s actually all we need for now. The next step is to use this transition matrix to make predictions.</p>

<h3 id="using-transition-matrix-to-make-predictions">Using Transition Matrix to Make Predictions</h3>

<p>In the previous section we showed how to create a transition matrix. Once we have it, the next step is to estimate the number of customers we will have in each segment in the future. This can be done for any number of years, although most companies will stop after three, five, or at most ten years.<br />
To estimate these numbers, we need to consider two things: the transition matrix and the current number of customers in each segment. Remember, the transition matrix shows how customers got to where they are today. We will use the same information to estimate where they will be in the future.</p>

<p>Without going into too much mathematical detail, this process involves multiplying a matrix by a vector. To do this, we multiply the transition matrix by a vector representing the number of customers in each segment to date. The result of this process is then a new vector containing the estimated number of customers in each segment next year. By multiplying this new vector again by the same transition matrix, we can estimate the number of customers in each segment two years from now, and so on.</p>

<p>We will now look at how this can be achieved in Python:</p>

<p>So, we have a transition matrix that shows the likelihood of customers moving from one segment to another over one year. To use this information, we will prepare a matrix or placeholder to store our predictions. The number of rows in this matrix will be the number of segments we have, and the number of columns will be the number of years we are predicting the evolution of segment membership. In this case, we are going to predict over ten periods in the future and include one more for the present. So, we start by creating an empty 8x11 matrix.</p>

<p>The first thing we need to do is to populate the first column with the number of customers in each segment as of the end of 2015. And then, we’ll give each row the name of its corresponding segment.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Initialize a placeholder matrix with then number of customers in each segment today
# and after 10 periods.
# The number of rows is the number of segments we have
# The number of columns is the number of years we are going to predict - 
# The evolution of segment membership
</span><span class="n">segments</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">11</span><span class="p">))</span>

<span class="c1"># 1st thing to do is to populate the first columns with then number of
# customers in each segment at the end of 2015
</span><span class="n">segments</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">].</span><span class="nf">value_counts</span><span class="p">(</span><span class="n">sort</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c1"># 2nd Give each column the name of its corresponding year 
# and row the name of its corresponding segment:
</span><span class="n">segments</span> <span class="o">=</span> <span class="n">pd</span><span class="p">.</span><span class="nc">DataFrame</span><span class="p">(</span><span class="n">segments</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span><span class="mi">2026</span><span class="p">),</span> <span class="n">index</span><span class="o">=</span><span class="n">customers_2015</span><span class="p">[</span><span class="sh">'</span><span class="s">segment</span><span class="sh">'</span><span class="p">].</span><span class="n">values</span><span class="p">.</span><span class="n">categories</span><span class="p">)</span>
</code></pre></div></div>

<p>As a result, we should see only the 2015 column filled with positive numbers, and all other years showing 0’s. Now, we would like to fill out these columns with predictions made using the transition matrix. So, for each column, the segments over that year would be a function of segments of the year before, multiplied by the transition matrix. To do that, we use a loop over all the given years, where each generated column is multiplied with the transition matrix and added to the next column, until we reach the end of the loop, which will be the year 2025.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Compute for each an every period
</span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">2016</span><span class="p">,</span> <span class="mi">2026</span><span class="p">):</span>
    <span class="n">segments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">segments</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="nf">dot</span><span class="p">(</span><span class="n">transition</span><span class="p">).</span><span class="nf">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">segments</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="nf">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    
<span class="c1"># Noneed for float64 since we are rounding the results:
</span><span class="n">segments</span> <span class="o">=</span> <span class="n">segments</span><span class="p">.</span><span class="nf">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
</code></pre></div></div>

<p>Now, if you look at the matrix we just created, it contains the segment names, the years, and the number of customers (rounded) in each segment at that time. We rounded the numbers because it doesn’t make sense to predict that we’ll have 0.4 customer in a segment.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># print resulting matrix
</span><span class="nf">print</span><span class="p">(</span><span class="n">segments</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="sh">'</span><span class="s">keys</span><span class="sh">'</span><span class="p">,</span> <span class="n">tablefmt</span><span class="o">=</span><span class="sh">'</span><span class="s">psql</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-tex highlighter-rouge"><div class="highlight"><pre class="highlight"><code>                   2015   2016   2017   2018   2019   2020   2021   2022  <span class="k">\
</span>inactive           9158  10517  11539  12636  12940  13185  13386  13542   
cold               1903   1584   1711    874    821    782    740    709   
warm high value     119    144    165    160    157    152    149    146   
warm low value      901    991   1058    989    938    884    844    813   
new warm            938    987      0      0      0      0      0      0   
active high value   573    657    639    625    608    594    582    571   
active low value   3313   3537   3306   3134   2954   2820   2717   2637   
new active         1512      0      0      0      0      0      0      0   

                    2023   2024   2025  
inactive           13664  13760  13834  
cold                 685    665    651  
warm high value      143    141    139  
warm low value       789    771    756  
new warm               0      0      0  
active high value    562    554    548  
active low value    2575   2527   2490  
new active             0      0      0  
</code></pre></div></div>

<p>Let’s now plot the evolution of inactive customers over all the forecasted years as a bar plot.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Plot inactive customers over time
</span><span class="n">segments</span><span class="p">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="sh">'</span><span class="s">bar</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="imgcap">
<img src="/assets/9/inactive.png" style="zoom:90%;" alt="inactive customers over the years" />
<div class="thecap"> Inactive Customers over the Years</div></div>

<p>These are our predictions. We begin at around 9,158, and then we expect the number of inactive customers to grow quickly and then stabilize around 13,000. You can do that in other segments and see how they change overtime.</p>

<p>If you take a look at the last row in the table above, specifically the number of new active customers, you’ll notice that we have 1,512 in 2015 and zeros in all other years. This is because once a customer is already in the database, they cannot become new again. The only way for a customer to become new is to be acquired. In this case, we are only measuring the CLV of those customers who are already in the database. This means that new active customers will eventually become something else, like warm, active, cold, or inactive customers over time. Thus, this segment will remain empty unless we run acquisition campaigns and add new customers to the database.<br />
Now, we don’t have any forecast of the generated revenues yet, and that’s what we’re going to do in the next section.</p>

<h3 id="computing-clv">Computing CLV</h3>

<p>Now that we have the number of customers per segment for each year, we just need to convert these figures into dollars or euros. The first step is to assume that the revenue generated by a customer can be fully explained and predicted by the segment to which they belong, whether it’s today or ten years from now.<br />
For instance, if customers in high-value segment generates on average $600, we’ll assume that this figure will not change over the years. In reality, it might go up or down, but without additional information, our best guess is to assume that this figure will remain stable over time. However, we need to take into account the time value of money when calculating CLV, as a dollar received today is worth more than a dollar received in the future. This is where discounting comes in. By discounting future revenues, we can compare them to today’s acquisition costs and determine if it’s a good investment. So discounting is a way of adjusting the value of money received or paid in the future to its present value. This means that the longer you have to wait to generate revenues from a customer segment, the less valuable they will be for your organization today.</p>

<p>So let’s translate that into a Python code. We start first by computing the average revenue per customer per segment. That we’ve already done in the previous blog entry and looks as follows:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Show average revenue per customer and per segment
</span><span class="nf">aggregate</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">actual</span><span class="err">$</span><span class="n">revenue_2015</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="nf">list</span><span class="p">(</span><span class="n">customers_2015</span><span class="err">$</span><span class="n">segment</span><span class="p">),</span> <span class="n">mean</span><span class="p">)</span>
</code></pre></div></div>

<p>Customers who were inactive, cold, warm, by definition generate no revenue at all. The active high value customers on average generate $323 of revenue per year. And then for the active low value and new active, it goes down to $52 and $79. So we’re going to just take the data from that analysis and store it, in a variable called <code class="language-plaintext highlighter-rouge">average_revenue</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Average yearly revenue per segment
# This comes directly from the previous post
</span><span class="n">average_revenue</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">323.57</span><span class="p">,</span> <span class="mf">52.31</span><span class="p">,</span> <span class="mf">79.17</span><span class="p">]</span>
</code></pre></div></div>

<p>Now we take the variable called <code class="language-plaintext highlighter-rouge">segments</code>, which contains predictions of segment membership over the next 11 years and multiply it by how much revenue each segment generated in average by 2015. As result we get an 8x11 matrix showing a forecast of how much each segment will generate over the next 10 years.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Compute revenue per segment
</span><span class="n">revenue_per_segment</span> <span class="o">=</span> <span class="n">segments</span><span class="p">.</span><span class="nf">multiply</span><span class="p">(</span><span class="n">average_revenue</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="sh">'</span><span class="s">index</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<p>The next step to do is to compute the sum of each column, that is yearly revenues, and we store the result under <code class="language-plaintext highlighter-rouge">yearly_revenue</code>.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Compute yearly revenue
</span><span class="n">yearly_revenue</span> <span class="o">=</span> <span class="n">revenue_per_segment</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">).</span><span class="nf">round</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">yearly_revenue</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">2015</span>   <span class="mi">478</span><span class="p">,</span><span class="mf">414.00</span>
<span class="mi">2016</span>   <span class="mi">397</span><span class="p">,</span><span class="mf">606.00</span>
<span class="mi">2017</span>   <span class="mi">379</span><span class="p">,</span><span class="mf">698.00</span>
<span class="mi">2018</span>   <span class="mi">366</span><span class="p">,</span><span class="mf">171.00</span>
<span class="mi">2019</span>   <span class="mi">351</span><span class="p">,</span><span class="mf">254.00</span>
<span class="mi">2020</span>   <span class="mi">339</span><span class="p">,</span><span class="mf">715.00</span>
<span class="mi">2021</span>   <span class="mi">330</span><span class="p">,</span><span class="mf">444.00</span>
<span class="mi">2022</span>   <span class="mi">322</span><span class="p">,</span><span class="mf">700.00</span>
<span class="mi">2023</span>   <span class="mi">316</span><span class="p">,</span><span class="mf">545.00</span>
<span class="mi">2024</span>   <span class="mi">311</span><span class="p">,</span><span class="mf">445.00</span>
<span class="mi">2025</span>   <span class="mi">307</span><span class="p">,</span><span class="mf">568.00</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</code></pre></div></div>

<p>We can see that we’ve generated $478,000 in 2015. However, over time as customers become inactive, this number will decrease, and by 2025 we’ll have without discounting only $307,000 in revenue. We can also create a bar plot to visualize this decrease in revenue over time.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">yearly_revenue</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="sh">'</span><span class="s">bar</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="imgcap">
<img src="/assets/9/yearly_revenues.png" style="zoom:90%;" alt="inactive customers over the years" />
<div class="thecap"> Yearly Total Revenues From Customer Base</div></div>

<p>If we want to calculate the cumulative revenue over the years, also known as Customer Equity (CE) we can use the <code class="language-plaintext highlighter-rouge">cumsum</code> function on the <code class="language-plaintext highlighter-rouge">yearly_revenue</code> variable.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Compute cumulated revenue
</span><span class="n">cumulated_revenue</span> <span class="o">=</span> <span class="n">yearly_revenue</span><span class="p">.</span><span class="nf">cumsum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">cumulated_revenue</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<span class="n">cumulated_revenue</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="sh">'</span><span class="s">bar</span><span class="sh">'</span><span class="p">)</span>
</code></pre></div></div>

<div class="imgcap">
<img src="/assets/9/cumsum.png" style="zoom:90%;" alt="inactive customers over the years" />
<div class="thecap"> Cumulative Revenues over 11 Years</div></div>

<p>As you can see, the cumulative revenue can only increase as we add new revenue each year. However, the slope of the curve will slowly decrease as we lose revenue from different customers each year.</p>

<p>It’s important to remember that a dollar ten years from now is not worth the same as a dollar today. That’s why we need to discount all of the forecasted revenues. I’ll be setting the discount rate at 10% and computing the discount rates for the next 10 years, from 2016 to 2025. We don’t need to discount the revenues of 2015, since it’s supposed to be the present. The formula for this is:  <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false">(</mo><mn>1</mn><mo>+</mo><mtext>discount rate</mtext><msup><mo stretchy="false">)</mo><mrow><mo>−</mo><mi>y</mi></mrow></msup></mrow><annotation encoding="application/x-tex">(1 + \text{discount rate})^{-y}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:1.0213em;vertical-align:-0.25em;"></span><span class="mord text"><span class="mord">discount rate</span></span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.7713em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">−</span><span class="mord mathnormal mtight" style="margin-right:0.03588em;">y</span></span></span></span></span></span></span></span></span></span></span></span>, where <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi></mrow><annotation encoding="application/x-tex">y</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span></span></span></span>  is the number of years until the revenue is received, and times <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo>−</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">-1</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7278em;vertical-align:-0.0833em;"></span><span class="mord">−</span><span class="mord">1</span></span></span></span> to say that it is a quotient - a discount.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Create a discount factor
</span><span class="n">discount_rate</span> <span class="o">=</span> <span class="mf">0.10</span>
<span class="n">discount</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">discount_rate</span><span class="p">)</span> <span class="o">**</span> <span class="n">np</span><span class="p">.</span><span class="nf">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">11</span><span class="p">))</span>
<span class="nf">print</span><span class="p">(</span><span class="n">discount</span><span class="p">)</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="mf">1.</span>         <span class="mf">0.90909091</span> <span class="mf">0.82644628</span> <span class="mf">0.7513148</span>  <span class="mf">0.68301346</span> <span class="mf">0.62092132</span>
 <span class="mf">0.56447393</span> <span class="mf">0.51315812</span> <span class="mf">0.46650738</span> <span class="mf">0.42409762</span> <span class="mf">0.38554329</span><span class="p">]</span>
</code></pre></div></div>

<p>In the first year, we don’t need to discount anything because that’s today’s money worth in today’s dollars. However, after the first year, a dollar would only be worth $0.90, then $0.82, and so on. After ten years, a dollar will only be worth $0.38.<br />
Now if we multiply <code class="language-plaintext highlighter-rouge">yearly_revenues</code> by the discount rates, we get the true value of each forecasted revenue in today’s dollars.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Compute discounted yearly revenue
# Future revenues in todays money
</span><span class="n">disc_yearly_revenue</span> <span class="o">=</span> <span class="n">yearly_revenue</span><span class="p">.</span><span class="nf">multiply</span><span class="p">(</span><span class="n">discount</span><span class="p">)</span>
<span class="nf">print</span><span class="p">(</span><span class="n">disc_yearly_revenue</span><span class="p">.</span><span class="nf">round</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
</code></pre></div></div>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">2015</span>   <span class="mi">478</span><span class="p">,</span><span class="mf">414.00</span>
<span class="mi">2016</span>   <span class="mi">361</span><span class="p">,</span><span class="mf">460.00</span>
<span class="mi">2017</span>   <span class="mi">313</span><span class="p">,</span><span class="mf">800.00</span>
<span class="mi">2018</span>   <span class="mi">275</span><span class="p">,</span><span class="mf">110.00</span>
<span class="mi">2019</span>   <span class="mi">239</span><span class="p">,</span><span class="mf">911.00</span>
<span class="mi">2020</span>   <span class="mi">210</span><span class="p">,</span><span class="mf">936.00</span>
<span class="mi">2021</span>   <span class="mi">186</span><span class="p">,</span><span class="mf">527.00</span>
<span class="mi">2022</span>   <span class="mi">165</span><span class="p">,</span><span class="mf">596.00</span>
<span class="mi">2023</span>   <span class="mi">147</span><span class="p">,</span><span class="mf">671.00</span>
<span class="mi">2024</span>   <span class="mi">132</span><span class="p">,</span><span class="mf">083.00</span>
<span class="mi">2025</span>   <span class="mi">118</span><span class="p">,</span><span class="mf">581.00</span>
<span class="n">dtype</span><span class="p">:</span> <span class="n">float64</span>
</code></pre></div></div>

<p>As we can see above, the $307,568 in 2025 is equivalent to $118,000 in today’s money, which makes a big difference. It’s important to remember that money you’ll receive in the future is worth less than money you receive today. Only by discounting future revenues, we can compare them to today’s acquisition costs and see if it’s a good investment. Indeed, discounting adjusts the value of money received or paid in the future to its present value. So even though a future revenue may seem high, it may not be worth as much as it seems when considering the time value of money. Therefore, always remember to discount future dollars!</p>

<p>When we plot these figures, we can see that the discounted revenue is high in the beginning and then drops dramatically as the years go by, since the further away in the future you get, the less worth the revenue is in today’s dollars.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">ax1</span> <span class="o">=</span> <span class="n">disc_yearly_revenue</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="sh">'</span><span class="s">bar</span><span class="sh">'</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax1</span><span class="p">.</span><span class="nf">twiny</span><span class="p">()</span>
<span class="n">yearly_revenue</span><span class="p">.</span><span class="nf">plot</span><span class="p">(</span><span class="n">kind</span><span class="o">=</span><span class="sh">'</span><span class="s">line</span><span class="sh">'</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax2</span><span class="p">)</span>
</code></pre></div></div>

<div class="imgcap">
<img src="/assets/9/revenues_discounted.png" style="zoom:90%;" alt="inactive customers over the years" />
<div class="thecap"> Discounted vs Non-Discounted Yearly Revenues</div></div>

<h2 id="conclusion">Conclusion</h2>

<p>In summary, CLV analysis is a critical aspect for any retailer to understand and implement in order to gain a competitive advantage in today’s overcrowded marketplace. By capturing and evaluating CLV, you can determine how much to spend on acquiring new customers, identify and target top future customers, minimize spending on unprofitable ones, and/or build more sustainable and beneficial relationships with your customer base. After all, only by understanding your customers’ buying behaviors, preferences, and concerns can you design more targeted marketing campaigns, personalize your value-added services, and thus improve overall satisfaction and retention.</p>

<p>Now, aside from being an incredibly important metric for retailers, CLV analysis is relatively easy to integrate into your daily operations thanks to the availability of customer’s data and the digital transformation taking place right now. In fact, any serious Customer Relationship Management (CRM) software or e-commerce system already has CLV metrics built in, so you don’t even have to implement them yourself.
As such, this tutorial wasn’t only about how to implement CLV, but rather about understanding how it fundamentally works and the competitive advantages it can bring to your business.</p>

<p>That said, CLV can only deliver those benefits once you stop limiting yourself to short-term transactions and shift your marketing strategies to a customer-centric approach based on building sustainable relationships with your customer base.</p>

<h2 id="references">References</h2>

<ol>
  <li>Netzer, Oded &amp; Lattin, James. (2008). A Hidden Markov Model of Customer Relationship Dynamics. Marketing Science. 27. 10.1287/mksc.1070.0294.</li>
  <li>Lilien, Gary L, Arvind Rangaswamy, and Arnaud De Bruyn. 2017. Principles of Marketing Engineering and Analytics. State College, PA: Decisionpro.</li>
  <li>Grönroos, Christian. 1991. “The Marketing Strategy Continuum: Towards a MarketingConcept for the 1990s.” Management Decision 29 (1). https://doi.org/10.1108/00251749110139106.</li>
  <li>Tarokh, MohammadJafar, and Mahsa EsmaeiliGookeh. n.d. “A New Model to Speculate CLV Based on Markov Chain Model,” 19.</li>
  <li>Bendle, Neil T., and Charan K. Bagga. 2017. “The Confusion About CLV in Case-Based Teaching Materials.” Marketing Education Review 27 (1): 27–38. https://doi.org/10.1080/10528008.2016.1255561.</li>
  <li>Pfeifer, Phillip E., and Robert L. Carraway. 2000. “Modeling Customer Relationships as Markov Chains.” Journal of Interactive Marketing 14 (2): 43–55. https://doi.org/10.1002/(SICI)1520-6653(200021)14:2&lt;43::AID-DIR4&gt;3.0.CO;2-H.</li>
  <li>Arnaud De Bruyn. <a href="https://www.coursera.org/learn/foundations-marketing-analytics">Foundations of marketing analytics</a> (MOOC). Coursera.</li>
  <li>Dataset from <a href="https://github.com/skacem/Business-Analytics/tree/main/Datasets">Github repo</a>. Accessed 15 December 2021.</li>
</ol>

  </article>

</div>

<center>
<b>tagged in</b>: [

  
  <a href="/tag/Business Analytics"><code class="highligher-rouge"><nobr>Business Analytics</nobr></code></a>

  
  <a href="/tag/Tutorial"><code class="highligher-rouge"><nobr>Tutorial</nobr></code></a>

  
  <a href="/tag/RFM Analysis"><code class="highligher-rouge"><nobr>RFM Analysis</nobr></code></a>

  
  <a href="/tag/CLV"><code class="highligher-rouge"><nobr>CLV</nobr></code></a>

]
</center>

<br><br>
<center>
<div class="share-page">
    <a href="https://twitter.com/intent/tweet?text=Forecasting Customer Lifetime Value Using RFM-Analysis and Markov Chain&url=/ml/2022/03/01/Customer-Lifetime-Value-Prediction/&via=&related=" target="_blank" title="Share on Twitter"> <img alt="Tweet" src="/assets/images/flat_web_icon_set/color/Twitter.png" /></a>
    <a href="http://www.reddit.com/submit?url=/ml/2022/03/01/Customer-Lifetime-Value-Prediction/" target="_blank" title="Share on Reddit"><img alt="Reddit" src="/assets/images/flat_web_icon_set/color/Reddit.png" /></a>
    <a href="http://www.linkedin.com/shareArticle?mini=true&url=/ml/2022/03/01/Customer-Lifetime-Value-Prediction/&title=Forecasting Customer Lifetime Value Using RFM-Analysis and Markov Chain&summary=&source=" target="_blank" title="Share on LinkedIn"><img alt="Share on LinkedIn" src="/assets/images/flat_web_icon_set/color/LinkedIn.png" /></a>
    <a href="https://plus.google.com/share?url=/ml/2022/03/01/Customer-Lifetime-Value-Prediction/" target="_blank" title="Share on Google+"><img alt="Share on Google+" src="/assets/images/flat_web_icon_set/color/Google+.png"></a>
    <a href="https://www.facebook.com/sharer/sharer.php?u=/ml/2022/03/01/Customer-Lifetime-Value-Prediction/&quote=Forecasting Customer Lifetime Value Using RFM-Analysis and Markov Chain" title="Share on Facebook" target="_blank"><img alt="Share on Facebook" src="/assets/images/flat_web_icon_set/color/Facebook.png" /></a>
</div>
</center>

<div>
  <br>
  <center>
    <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
    <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" />
    </a>
    <br>
    Content licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"> CC BY-NC-SA 4.0 International License</a>
  </center>
  <br>
</div>


  <div id="disqus_thread"></div>
<script>

/**
*  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
*  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables*/

var disqus_config = function () {
this.page.url = '/ml/2022/03/01/Customer-Lifetime-Value-Prediction/'; // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = /ml/2022/03/01/Customer-Lifetime-Value-Prediction/; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://skacem.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



      </div>
    </div>
    <footer class="site-footer">
  <div class="wrap">
    <div class="footer-top">
      <center>
      <ul>
        
          <li><a class="site-link" href="mailto:skanderkacem@gmail.com"><i class="fa fa-envelope-square fa-fw fa-2x"></i></a></li>
        

        

        
          <li><a class="site-link" href="https://github.com/skacem"><i class="fa fa-github-square fa-fw fa-2x"></i></a></li>
        

        

        

        <li><a class="site-link" href="/feed.xml"><i class="fa fa-rss-square fa-fw fa-2x"></i></a></li>
        <br>

      </center>
    </div>
    <div class="footer-bottom"></div>
  </div>
</footer>
    </body>
</html>